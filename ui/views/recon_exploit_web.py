"""–í–∫–ª–∞–¥–∫–∏: –†–∞–∑–≤–µ–¥–∫–∞, –≠–∫—Å–ø–ª–æ–π—Ç, –í–µ–±-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å."""

import os
import time
import json
import streamlit as st
from ui.security import validate_url, validate_domain, safe_error_message, check_rate_limit, RATE_LIMIT_SCAN_PER_MIN


def render_recon(tab) -> None:
    with tab:
        st.subheader("–†–∞–∑–≤–µ–¥–∫–∞")
        with st.expander("–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è", expanded=False):
            st.markdown("–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–∞–∑–≤–µ–¥–∫—É ‚Äî –ø–æ–¥–¥–æ–º–µ–Ω—ã (crt.sh), —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, Google dorks.")
        recon_domain_input = st.text_input("–î–æ–º–µ–Ω", "example.com", key="recon_domain")
        if st.button("–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞–∑–≤–µ–¥–∫—É", key="recon_btn"):
            ok, msg = validate_domain(recon_domain_input)
            if not ok:
                st.warning(msg)
            else:
                with st.spinner("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è..."):
                    try:
                        from modules.recon import recon_domain as recon_fn
                        base = recon_domain_input.split("//")[-1].split("/")[0].split(":")[0]
                        data = recon_fn(base, subdomain_limit=50)
                        st.session_state["recon_data"] = data
                    except Exception:
                        st.error(safe_error_message(None))
        if st.session_state.get("recon_data"):
            d = st.session_state["recon_data"]
            st.markdown("#### –ü–æ–¥–¥–æ–º–µ–Ω—ã")
            st.json(d.get("subdomains", [])[:30])
            st.markdown("#### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏")
            st.json(d.get("technologies", []))
            with st.expander("Google dorks"):
                for q in d.get("dorks", [])[:10]:
                    st.code(q, language=None)


def render_exploit(tab) -> None:
    with tab:
        st.subheader("–≠–∫—Å–ø–ª–æ–π—Ç")
        with st.expander("–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è", expanded=False):
            st.markdown("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É—è–∑–≤–∏–º–æ—Å—Ç–∏ (SQLi, XSS, LFI). –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç–∫—Å–ø–ª–æ–π—Ç. –ü–æ–¥—Å–∫–∞–∑–∫–∞ ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–≤–µ—Ç–∞.")
        ex_url = st.text_input("–¶–µ–ª–µ–≤–æ–π URL", "http://testphp.vulnweb.com/listproducts.php?id=1", key="ex_url")
        ex_type = st.selectbox("–¢–∏–ø —É—è–∑–≤–∏–º–æ—Å—Ç–∏", ["SQL Injection", "XSS", "LFI"], key="ex_type")
        ex_param = st.text_input("–ü–∞—Ä–∞–º–µ—Ç—Ä (–Ω–µ–æ–±—è–∑.)", "id", key="ex_param")
        if st.button("–ó–∞–ø—É—Å—Ç–∏—Ç—å —ç–∫—Å–ø–ª–æ–π—Ç", key="ex_btn"):
            ok, msg = validate_url(ex_url)
            if not ok:
                st.error(msg)
            else:
                with st.spinner("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è..."):
                    try:
                        from core.exploiter import run_exploit
                        v = "sqli" if "SQL" in ex_type else ("xss" if "XSS" in ex_type else "lfi")
                        ctx = {"param": ex_param} if ex_param else None
                        res = run_exploit(v, ex_url, ctx)
                        st.session_state["exploit_result"] = res
                    except Exception:
                        st.error(safe_error_message(None))
        if st.session_state.get("exploit_result"):
            st.json(st.session_state["exploit_result"])
        st.markdown("#### –ü–æ–¥—Å–∫–∞–∑–∫–∞")
        hint_ctx = st.text_area("–ö–æ–Ω—Ç–µ–∫—Å—Ç (—É—è–∑–≤–∏–º–æ—Å—Ç—å, WAF, —Ç–∏–ø –ë–î)", "SQLi –≤ ?id=, MySQL", key="hint_ctx")
        if st.button("–ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É", key="hint_btn"):
            if not (os.environ.get("OPENROUTER_API_KEY") or "").strip():
                st.warning("–£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á API –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏.")
            else:
                try:
                    from core.ai_engine import ai_exploit_hint
                    h = ai_exploit_hint("SQL Injection", {"context": hint_ctx})
                    st.info(h or "–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
                except Exception:
                    st.warning(safe_error_message(None))


def render_web_security(tab) -> None:
    with tab:
        st.subheader("–í–µ–±-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (OWASP Top 10)")
        with st.expander("–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è", expanded=False):
            st.markdown("""
–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π URL. **–ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç** ‚Äî —Å–∫–∞–Ω –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã. **–ì–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç** ‚Äî –ø—Ä–æ–≤–∞–ª–∏–≤–∞–µ—Ç—Å—è –≤ –ø–æ–¥–¥–æ–º–µ–Ω—ã, –∫—Ä–∞—É–ª–∏—Ç –≤—Å–µ —Ö–æ—Å—Ç—ã, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–π URL (SQLi, XSS, CSRF, SSRF, Network).

**–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª–∏–≥–æ–Ω:** `http://testphp.vulnweb.com` ‚Äî –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ —Å–∫–∞–Ω–∞ –Ω–∞–π–¥—ë—Ç listproducts.php, search.php –∏ –¥—Ä.
            """)
        col_url, col_to = st.columns([3, 1])
        target_url = col_url.text_input(
            "–¶–µ–ª–µ–≤–æ–π URL",
            value="http://testphp.vulnweb.com/listproducts.php?cat=1",
            key="web_target_url",
        )
        timeout = col_to.slider("–¢–∞–π–º–∞—É—Ç (—Å)", 5, 60, 25, key="web_timeout")
        with st.expander("–ö—Ä–∞—É–ª–µ—Ä (–æ–±—Ö–æ–¥ —Å–∞–π—Ç–∞)", expanded=False):
            crawl_max = st.number_input("–ú–∞–∫—Å. —Å—Ç—Ä–∞–Ω–∏—Ü", min_value=5, max_value=50, value=15, key="crawl_max")
            if st.button("–ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫–∏", key="crawl_btn"):
                ok, msg = validate_url(target_url)
                if not ok:
                    st.warning(msg)
                else:
                    with st.spinner("–û–±—Ö–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü..."):
                        try:
                            from modules.crawler import crawl_urls
                            urls = crawl_urls(target_url, max_pages=int(crawl_max), timeout=8)
                            st.session_state["crawler_urls"] = urls
                        except Exception:
                            st.error(safe_error_message(None))
            if st.session_state.get("crawler_urls"):
                st.caption(f"–ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü: {len(st.session_state['crawler_urls'])}")
                for u in st.session_state["crawler_urls"][:30]:
                    st.code(u, language=None)
        st.divider()
        c1, c2, c3, c4, c5 = st.columns(5)

        def run_single(name, func_name):
            ok, msg = validate_url(target_url)
            if not ok:
                st.warning(msg)
                return
            with st.spinner(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ {name}..."):
                try:
                    import websec
                    func = getattr(websec, func_name)
                    start_time = time.time()
                    detected = func(target_url)
                    is_hit = len(detected) > 0 if isinstance(detected, list) else detected
                    duration = time.time() - start_time
                    if is_hit:
                        st.error(f"üî¥ {name}: –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ ({duration:.1f} —Å)")
                    else:
                        st.success(f"üü¢ {name}: —á–∏—Å—Ç–æ ({duration:.1f} —Å)")
                except ImportError:
                    st.error("–ú–æ–¥—É–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
                except Exception:
                    st.error(safe_error_message(None))

        if c1.button("üîç SQLi"):
            run_single("SQL Injection", "scan_sql_injection")
        if c2.button("üîç XSS"):
            run_single("XSS", "scan_xss")
        if c3.button("üîç CSRF"):
            run_single("CSRF", "check_csrf_protection")
        if c4.button("üîç SSRF"):
            run_single("SSRF", "scan_ssrf")
        if c5.button("üåê –°–µ—Ç—å"):
            run_single("–°–µ—Ç—å", "scan_network_segmentation")
        c6, c7, c8 = st.columns(3)
        if c6.button("CORS"):
            ok, msg = validate_url(target_url)
            if not ok:
                st.warning(msg)
            else:
                with st.spinner("–ü—Ä–æ–≤–µ—Ä–∫–∞ CORS..."):
                    try:
                        from scanners.cors_scanner import scan_cors
                        issues = scan_cors(target_url)
                        st.error(f"CORS: {len(issues)} –ø—Ä–æ–±–ª–µ–º") if issues else st.success("CORS: —á–∏—Å—Ç–æ")
                        if issues:
                            for i in issues:
                                st.caption(i)
                    except Exception:
                        st.error(safe_error_message(None))
        if c7.button("Host header"):
            ok, msg = validate_url(target_url)
            if not ok:
                st.warning(msg)
            else:
                with st.spinner("–ü—Ä–æ–≤–µ—Ä–∫–∞ Host header..."):
                    try:
                        from scanners.host_header_scanner import scan_host_header
                        issues = scan_host_header(target_url)
                        st.error(f"Host: {len(issues)} –ø—Ä–æ–±–ª–µ–º") if issues else st.success("Host header: —á–∏—Å—Ç–æ")
                        if issues:
                            for i in issues:
                                st.caption(i)
                    except Exception:
                        st.error(safe_error_message(None))
        if c8.button("SSTI"):
            ok, msg = validate_url(target_url)
            if not ok:
                st.warning(msg)
            else:
                with st.spinner("–ü—Ä–æ–≤–µ—Ä–∫–∞ SSTI..."):
                    try:
                        from scanners.ssti_scanner import scan_ssti
                        issues = scan_ssti(target_url)
                        st.error(f"SSTI: {len(issues)} –ø—Ä–æ–±–ª–µ–º") if issues else st.success("SSTI: —á–∏—Å—Ç–æ")
                        if issues:
                            for i in issues:
                                st.caption(i)
                    except Exception:
                        st.error(safe_error_message(None))
        st.divider()
        if "scan_results" not in st.session_state:
            st.session_state.scan_results = None
        audit_col1, audit_col2 = st.columns(2)
        with audit_col1:
            if st.button("–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç", type="primary", use_container_width=True):
                ok, msg = validate_url(target_url)
                if not ok:
                    st.error(msg)
                else:
                    allowed, rate_msg = check_rate_limit("web_audit", RATE_LIMIT_SCAN_PER_MIN)
                    if not allowed:
                        st.warning(rate_msg)
                    else:
                        with st.spinner("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç..."):
                            try:
                                import websec
                                try:
                                    st.session_state.scan_results = websec.ctf_scan(
                                        target_url, profile="ctf_quick", find_flags=False, timeout=float(timeout)
                                    )
                                except Exception:
                                    res = websec.full_scan(target_url, timeout=float(timeout))
                                    if not res.get("report"):
                                        res["report"] = [
                                            {"id": "owasp", "name": "OWASP Top 10", "description": "–ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç.", "result_text": "–≤—ã–ø–æ–ª–Ω–µ–Ω–æ"}
                                        ]
                                    st.session_state.scan_results = res
                                res = st.session_state.scan_results
                                try:
                                    from core.audit_log import log_scan
                                    log_scan(target_url, "full", res.get("metrics", {}).get("vuln_count", 0))
                                except Exception:
                                    pass
                                try:
                                    from core.webhook import webhook_scan_complete
                                    webhook_scan_complete(res)
                                except Exception:
                                    pass
                            except Exception:
                                st.error(safe_error_message(None))
        with audit_col2:
            if st.button("üï∑Ô∏è –ì–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç (–ø–æ–¥–¥–æ–º–µ–Ω—ã)", type="secondary", use_container_width=True):
                ok, msg = validate_url(target_url)
                if not ok:
                    st.error(msg)
                else:
                    allowed, rate_msg = check_rate_limit("web_audit", RATE_LIMIT_SCAN_PER_MIN)
                    if not allowed:
                        st.warning(rate_msg)
                    else:
                        with st.spinner("–ü–æ–¥–¥–æ–º–µ–Ω—ã ‚Üí –∫—Ä–∞—É–ª–∏–Ω–≥ ‚Üí —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö URL..."):
                            try:
                                import websec
                                st.session_state.scan_results = websec.deep_scan(
                                    target_url,
                                    max_subdomains=8,
                                    max_pages_per_host=5,
                                    max_urls_to_scan=20,
                                    timeout=120.0,
                                )
                            except Exception:
                                st.error(safe_error_message(None))
        if st.session_state.scan_results:
            res = st.session_state.scan_results
            cols = st.columns(4 if res.get("profile") == "deep" else 3)
            cols[0].metric("–û—Ü–µ–Ω–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", f"{res['metrics']['score']}/100")
            cols[1].metric("–£—è–∑–≤–∏–º–æ—Å—Ç–∏", res['metrics']['vuln_count'])
            cols[2].metric("–í—Ä–µ–º—è —Å–∫–∞–Ω–∞", f"{res['metrics']['scan_time']} —Å")
            if res.get("profile") == "deep" and res.get("metrics", {}).get("urls_scanned") and len(cols) > 3:
                cols[3].metric("URL –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ", res["metrics"]["urls_scanned"])
            if res.get("report"):
                st.markdown("#### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ")
                for i, item in enumerate(res["report"], 1):
                    name = item.get("name", item.get("id", ""))
                    desc = item.get("description", "")
                    res_text = item.get("result_text", item.get("result", ""))
                    st.markdown(f"**{i}. {name}** ‚Äî {desc} **–†–µ–∑—É–ª—å—Ç–∞—Ç:** {res_text}.")
            if res['vulnerabilities']:
                st.error("–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ: " + ", ".join(res['vulnerabilities'][:15]) + ("..." if len(res['vulnerabilities']) > 15 else ""))
                if res.get("profile") == "deep" and res.get("vuln_details"):
                    with st.expander("–£—è–∑–≤–∏–º–æ—Å—Ç–∏ –ø–æ URL", expanded=False):
                        for d in res["vuln_details"][:30]:
                            st.caption(f"**{d.get('vuln', '')}** ‚Äî {d.get('url', '')}")
            if res.get("profile") == "deep":
                with st.expander("–ü–æ–¥–¥–æ–º–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ URL", expanded=False):
                    st.caption("–ü–æ–¥–¥–æ–º–µ–Ω—ã: " + ", ".join(res.get("subdomains", [])[:20]))
                    for u in res.get("scanned_urls", [])[:25]:
                        st.code(u, language=None)
            else:
                st.success("–ü—Ä–∏–∑–Ω–∞–∫–æ–≤ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.")
            st.markdown("#### –ê–Ω–∞–ª–∏–∑")
            with st.expander("–û—Ç—á—ë—Ç (EN)", expanded=False):
                st.info(res.get('ai_analysis', {}).get('en', ''))
            with st.expander("–û—Ç—á—ë—Ç (RU)", expanded=False):
                st.info(res.get('ai_analysis', {}).get('ru', ''))
            st.markdown("#### –û—Ç—á—ë—Ç—ã")
            d1, d2, d3 = st.columns(3)
            if 'reports' in res:
                d1.download_button("EN (MD)", res['reports']['en_md'], f"report_en_{int(time.time())}.md")
                d2.download_button("RU (MD)", res['reports']['ru_md'], f"report_ru_{int(time.time())}.md")
            d3.download_button("JSON", json.dumps(res, indent=2, ensure_ascii=False), f"data_{int(time.time())}.json")
