import os
import json
import time
from typing import List, Tuple, Optional, Dict
from datetime import datetime

# Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
client = None
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ ÑĞºĞ°Ğ½ĞµÑ€Ğ¾Ğ² Ñ graceful fallback
try:
    from scanners.sql_scanner import scan_sql_injection
    from scanners.xss import scan_xss
    from scanners.csrf_scanner import check_csrf_protection
    from scanners.ssrf_scanner import scan_ssrf
    from scanners.network_scanner import scan_network_segmentation
    print("âœ… Ğ’ÑĞµ ÑĞºĞ°Ğ½ĞµÑ€Ñ‹ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹")
except ImportError as e:
    print(f"âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ° ÑĞºĞ°Ğ½ĞµÑ€Ğ¾Ğ²: {e}")
    # Fallback Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
    def scan_sql_injection(url): return False
    def scan_xss(url): return False
    def check_csrf_protection(url): return False
    def scan_ssrf(url): return False
    def scan_network_segmentation(url): return []

def ai_analysis(vulnerabilities: List[str]) -> Tuple[str, str]:
    """
    ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ğ¹ fallback AI-Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· (Ğ±ĞµĞ· OpenAI Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸).
    """
    if not vulnerabilities:
        return (
            "âœ… No critical vulnerabilities detected.",
            "âœ… ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾."
        )
    
    vulns_str = ", ".join(vulnerabilities)
    return (
        f"ğŸš¨ Found: {vulns_str}. Prioritize fixes: HIGH risk.",
        f"ğŸš¨ ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾: {vulns_str}. ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ: Ğ’Ğ«Ğ¡ĞĞšĞ˜Ğ™."
    )

def full_scan(url: str) -> Dict:
    """
    ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ°Ğ¼Ğ¸.
    """
    print(f"ğŸ” Scanning {url}...")
    results = {
        "timestamp": datetime.now().isoformat(),
        "target": url,
        "vulnerabilities": [],
        "metrics": {},
        "ai_analysis": {"en": "", "ru": ""}
    }
    
    t0 = time.time()
    try:
        # Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
        scans = [
            ("SQL Injection", scan_sql_injection(url)),
            ("XSS", scan_xss(url)),
            ("CSRF", check_csrf_protection(url)),
            ("SSRF", scan_ssrf(url))
        ]
        
        for name, detected in scans:
            status = 'ğŸŸ¡ DETECTED' if detected else 'ğŸŸ¢ CLEAN'
            print(f"  {name}: {status}")
            if detected:
                results["vulnerabilities"].append(name)
        
        net_issues = scan_network_segmentation(url)
        if net_issues:
            results["vulnerabilities"].extend([f"Network: {issue}" for issue in net_issues])
        
        # ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸
        results["metrics"] = {
            "scan_time": round(time.time() - t0, 2),
            "vuln_count": len(results["vulnerabilities"]),
            "security_score": max(0, 100 - len(results["vulnerabilities"]) * 20)
        }
        
        # AI
        results["ai_analysis"]["en"], results["ai_analysis"]["ru"] = ai_analysis(
            results["vulnerabilities"]
        )
        
    except KeyboardInterrupt:
        print("\nğŸ‘‹ Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼")
        results["status"] = "interrupted"
    except Exception as e:
        print(f"ğŸ’¥ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸: {str(e)}")
        results["error"] = str(e)
    
    return results

def generate_reports(results: Dict) -> None:
    """Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğµ MD/JSON/TXT Ğ¾Ñ‚Ñ‡ĞµÑ‚Ñ‹."""
    ts = datetime.now().strftime("%Y%m%d_%H%M")
    os.makedirs("reports", exist_ok=True)
    
    vulns = results["vulnerabilities"]
    metrics = results["metrics"]
    
    # ĞŸĞĞ”Ğ ĞĞ‘ĞĞ«Ğ™ Markdown EN
    detailed_en = f"""# ğŸ›¡ï¸ WebSecAI Professional Report v2.0

## ğŸ¯ Target: {results["target"]}
**Timestamp:** {results["timestamp"]}  
**Duration:** {metrics["scan_time"]}s

## ğŸ“Š Executive Summary
| Metric | Value |
|--------|-------|
| **Vulnerabilities** | {len(vulns)} |
| **Security Score** | {metrics["security_score"]}/100 |
| **Risk Level** | {'ğŸ”´ CRITICAL' if len(vulns)>=3 else 'ğŸŸ¡ HIGH' if len(vulns)==2 else 'ğŸŸ¢ MEDIUM'} |

## ğŸš¨ Detailed Findings
{vulns and "\\n".join([f"â€¢ **{v}** - OWASP Top 10" for v in vulns]) or "âœ… No vulnerabilities detected"}

## ğŸ¤– AI Security Analysis
{results["ai_analysis"]["en"]}

---
**Generated by** WebSecAI Suite | GitHub: credibility-index/WebSec-AI
"""
    
    # ĞŸĞĞ”Ğ ĞĞ‘ĞĞ«Ğ™ Markdown RU  
    detailed_ru = f"""# ğŸ›¡ï¸ ĞŸÑ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞÑ‚Ñ‡Ñ‘Ñ‚ WebSecAI v2.0

## ğŸ¯ Ğ¦ĞµĞ»ÑŒ: {results["target"]}
**Ğ’Ñ€ĞµĞ¼Ñ:** {results["timestamp"]}  
**Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ:** {metrics["scan_time"]}Ñ

## ğŸ“Š Ğ¡Ğ²Ğ¾Ğ´ĞºĞ°
| ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ° | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|---------|----------|
| **Ğ£ÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹** | {len(vulns)} |
| **ĞÑ†ĞµĞ½ĞºĞ°** | {metrics["security_score"]}/100 |
| **Ğ Ğ¸ÑĞº** | {'ğŸ”´ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ™' if len(vulns)>=3 else 'ğŸŸ¡ Ğ’Ğ«Ğ¡ĞĞšĞ˜Ğ™' if len(vulns)==2 else 'ğŸŸ¢ Ğ¡Ğ Ğ•Ğ”ĞĞ˜Ğ™'} |

## ğŸš¨ Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
{vulns and "\\n".join([f"â€¢ **{v}** - OWASP Top 10" for v in vulns]) or "âœ… Ğ£ÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹"}

## ğŸ¤– AI ĞĞ½Ğ°Ğ»Ğ¸Ğ·
{results["ai_analysis"]["ru"]}

---
**Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾** WebSecAI Suite | t.me/likeluv
"""
    
    # TXT Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ²/Telegram
    txt_report = f"""WebSecAI SCAN REPORT {ts}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

TARGET: {results["target"]}
VULNS: {len(vulns)} | SCORE: {metrics["security_score"]}/100
TIME: {metrics["scan_time"]}s

FINDINGS:
{chr(10).join(vulns) or "âœ… CLEAN"}

AI: {results["ai_analysis"]["en"][:200]}...

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
GitHub: credibility-index/WebSec-AI
"""
    
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ’Ğ¡Ğ•Ğ¥ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¾Ğ²
    formats = [
        (f"websec_en_{ts}.md", detailed_en),
        (f"websec_ru_{ts}.md", detailed_ru),
        (f"websec_full_{ts}.json", json.dumps(results, ensure_ascii=False, indent=2)),
        (f"websec_txt_{ts}.txt", txt_report)
    ]
    
    for filename, content in formats:
        with open(f"reports/{filename}", "w", encoding="utf-8") as f:
            f.write(content)
    
    print(f"âœ… 4 Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹:")
    print(f"   ğŸ“„ reports/websec_en_{ts}.md")
    print(f"   ğŸ“„ reports/websec_ru_{ts}.md") 
    print(f"   ğŸ“Š reports/websec_full_{ts}.json")
    print(f"   ğŸ“ reports/websec_txt_{ts}.txt")


def main():
    """CLI Ğ²Ñ…Ğ¾Ğ´."""
    print("\n=== ğŸ›¡ï¸ WebSecAI v2.0 ===")
    target = input("ğŸ¯ URL: ").strip()
    if not target.startswith(('http://', 'https://')):
        print("âŒ Invalid URL")
        return
    
    results = full_scan(target)
    print(f"\nğŸ“Š Vulns: {len(results['vulnerabilities'])} | Score: {results['metrics']['security_score']}")
    generate_reports(results)

def scan_crypto_wallet(address: str) -> bool:
    """Ğ”ĞµĞ¼Ğ¾ ĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾-ÑĞºĞ°Ğ½ĞµÑ€."""
    invalid_patterns = ['0x0*', 'bc1q0*']
    return any(pattern in address for pattern in invalid_patterns)

if __name__ == "__main__":
    try:
        os.makedirs("reports", exist_ok=True)
        main()
    except Exception as e:
        print(f"ğŸ’¥ Error: {str(e)}")
