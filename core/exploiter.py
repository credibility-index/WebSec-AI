"""Exploit orchestration: run exploitation for detected vulns (SQLi, XSS, LFI, etc.)."""
import logging
from typing import Any, Dict, List, Optional

logger = logging.getLogger("websec_ai")


def run_exploit(
    vuln_type: str,
    target_url: str,
    context: Optional[Dict[str, Any]] = None,
) -> Dict[str, Any]:
    """Run exploitation for given vuln type. context: e.g. param, method, db_type."""
    context = context or {}
    result = {
        "vulnerability": vuln_type,
        "target": target_url,
        "success": False,
        "data": {},
        "error": None,
    }
    try:
        vt = vuln_type.lower().replace(" ", "_")
        if vt in ("sqli", "sql_injection"):
            from modules.exploit_engine import exploit_sqli
            result["data"] = exploit_sqli(target_url, context)
            result["success"] = bool(result["data"].get("dumped_tables") or result["data"].get("extracted_data"))
        elif vt in ("xss",):
            from modules.exploit_engine import exploit_xss
            result["data"] = exploit_xss(target_url, context)
            result["success"] = bool(result["data"].get("payloads_tested"))
        elif vt in ("lfi", "rfi", "path_traversal"):
            from modules.exploit_engine import exploit_lfi
            result["data"] = exploit_lfi(target_url, context)
            result["success"] = bool(result["data"].get("read_files"))
        elif vt in ("rce", "command_injection", "cmd_injection"):
            from modules.exploit_engine import exploit_rce
            result["data"] = exploit_rce(target_url, context)
            result["success"] = result["data"].get("success")
        elif vt in ("ssrf",):
            from modules.exploit_engine import exploit_ssrf
            result["data"] = exploit_ssrf(target_url, context)
            result["success"] = bool(result["data"].get("accessible"))
        else:
            result["error"] = f"No exploit module for {vuln_type}"
    except Exception as e:
        logger.exception("Exploit failed")
        result["error"] = str(e)
    return result
